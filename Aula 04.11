--AULA 04-11-2022


SELECT COUNT(*)
FROM TB_PACIENTE

SELECT COUNT(*)
FROM TB_PASSAGEM

SELECT COUNT(*)
FROM TB_ENDERECO

SELECT COUNT(CEP)
FROM TB_ENDERECO

SELECT COUNT(*)
FROM TB_ENDERECO
WHERE CEP IS NOT NULL

SELECT COUNT(DISTINCT ID_PACIENTE)
FROM TB_PASSAGEM

SELECT ID_PACIENTE, COUNT(*)
FROM TB_PASSAGEM
GROUP BY ID_PACIENTE


SELECT PACIENTE, COUNT(*) AS QTD
FROM TB_PACIENTE AS P
JOIN TB_PASSAGEM AS PAS ON P.ID_PACIENTE = PAS.ID_PASSAGEM
GROUP BY PACIENTE
ORDER BY PACIENTE

SELECT SUM(QUANTIDADE) AS TOTAL
FROM TB_PASSAGEM_ITEM

SELECT SUM(QUANTIDADE) AS TOTAL
FROM TB_PASSAGEM_ITEM
WHERE YEAR(DT_LANCAMENTO) = 2018

SELECT MIN(QUANTIDADE) AS QTD_MENOR, MAX(QUANTIDADE) AS QTD_MAIOR, AVG(QUANTIDADE) AS MEDIA, COUNT(*) AS TOTAL_ITENS
FROM TB_PASSAGEM_ITEM



SELECT P.SEXO, SUM(I.PRECO_VENDA) AS TOTAL_VENDA
FROM TB_PACIENTE      AS P
JOIN TB_PASSAGEM      AS PASS ON PASS.ID_PACIENTE = P.ID_PACIENTE
JOIN TB_PASSAGEM_ITEM AS PAI  ON PAI.ID_PASSAGEM = PAI.ID_PASSAGEM
JOIN TB_ITEM          AS I    ON I.ID_ITEM = PAI.ID_ITEM
WHERE
YEAR(PASS.DATA_ADMISSAO) = 2018 AND 
MONTH(PASS.DATA_ADMISSAO) IN (1,2,12)
GROUP BY SEXO

--SELECT desc_escolaridade, COUNT(*) AS CONTAGEM
--FROM TB_escolaridade as E
--JOIN TB_PASSAGEM  AS PASS ON E.ID_escolaridade = PASS.ID_PASSAGEM
--GROUP BY desc_escolaridade



SELECT ESC.desc_escolaridade, COUNT(*) AS CONTAGEM
FROM TB_PACIENTE AS P
JOIN TB_PASSAGEM  AS PASS ON PASS.ID_PACIENTE = P.ID_PACIENTE
JOIN TB_escolaridade  AS ESC ON ESC.id_escolaridade = P.ESCOLARIDADE
GROUP BY ESC.desc_escolaridade


SELECT P.PACIENTE, YEAR(PASS.DATA_ADMISSAO) AS ANO, MONTH(PASS.DATA_ADMISSAO) AS MES,
SUM(PAI.QUANTIDADE*I.PRECO_CUSTO) AS TOTAL_VENDA
FROM TB_PACIENTE      AS P
JOIN TB_PASSAGEM      AS PASS ON PASS.ID_PACIENTE = P.ID_PACIENTE
JOIN TB_PASSAGEM_ITEM AS PAI  ON PAI.ID_PASSAGEM = PAI.ID_PASSAGEM
JOIN TB_ITEM          AS I    ON I.ID_ITEM = PAI.ID_ITEM
GROUP BY P.PACIENTE, YEAR(PASS.DATA_ADMISSAO), MONTH(PASS.DATA_ADMISSAO)
ORDER BY 1,2,3


SELECT TOP 15 I.DESC_ITEM, SUM(PAI.QUANTIDADE) AS QTD
FROM TB_PASSAGEM      AS PASS
JOIN TB_PASSAGEM_ITEM AS PAI  ON PAI.ID_PASSAGEM = PAI.ID_PASSAGEM
JOIN TB_ITEM          AS I    ON I.ID_ITEM = PAI.ID_ITEM
WHERE YEAR(PASS.DATA_ADMISSAO) IN (2015,2018)
GROUP BY I.DESC_ITEM
ORDER BY QTD DESC


SELECT E.ESTADO, E.CIDADE, SUM(PAI.QUANTIDADE*I.PRECO_CUSTO) AS TOTAL_VENDA
FROM TB_PACIENTE      AS P
JOIN TB_PASSAGEM      AS PASS ON PASS.ID_PACIENTE = P.ID_PACIENTE
JOIN TB_PASSAGEM_ITEM AS PAI  ON PAI.ID_PASSAGEM = PAI.ID_PASSAGEM
JOIN TB_ITEM          AS I    ON I.ID_ITEM = PAI.ID_ITEM
JOIN TB_ENDERECO      AS E    ON E.ID_PACIENTE = P.ID_PACIENTE
GROUP BY E.ESTADO, E.CIDADE



SELECT MAX(I.PRECO_VENDA*PAI.QUANTIDADE) AS MAIOR, MIN(I.PRECO_VENDA*PAI.QUANTIDADE) AS MENOR
FROM TB_PASSAGEM      AS PASS 
JOIN TB_PASSAGEM_ITEM AS PAI  ON PAI.ID_PASSAGEM = PASS.ID_PASSAGEM
JOIN TB_ITEM          AS I    ON I.ID_ITEM = PAI.ID_ITEM
WHERE YEAR(PASS.DATA_ADMISSAO) = 2018 AND MONTH(PASS.DATA_ADMISSAO) = 11



SELECT DATEDIFF(YEAR,P.DT_NASCIMENTO,PASS.DATA_ADMISSAO) AS IDADE, 
MAX(I.PRECO_VENDA*PAI.QUANTIDADE) AS MAIOR, MIN(I.PRECO_VENDA*PAI.QUANTIDADE) AS MENOR
FROM TB_PACIENTE      AS P
JOIN TB_PASSAGEM      AS PASS ON PASS.ID_PACIENTE = P.ID_PACIENTE
JOIN TB_PASSAGEM_ITEM AS PAI  ON PAI.ID_PASSAGEM = PAI.ID_PASSAGEM
JOIN TB_ITEM          AS I    ON I.ID_ITEM = PAI.ID_ITEM
WHERE YEAR(PASS.DATA_ADMISSAO) BETWEEN 2016 AND 2018 
GROUP BY DATEDIFF(YEAR,P.DT_NASCIMENTO,PASS.DATA_ADMISSAO)



SELECT TOP 1 ESC.desc_escolaridade, COUNT(*) AS QTD
FROM TB_PACIENTE AS P
JOIN TB_PASSAGEM  AS PASS ON PASS.ID_PACIENTE = P.ID_PACIENTE
JOIN TB_escolaridade  AS ESC ON ESC.id_escolaridade = P.ESCOLARIDADE
GROUP BY ESC.desc_escolaridade
ORDER BY QTD DESC


SELECT YEAR(P.DATA_ADMISSAO) AS ANO, MONTH(P.DATA_ADMISSAO) AS MES, DAY(P.DATA_ADMISSAO) AS DIA, T.desc_tipoadmissao, COUNT(*) QTD
FROM TB_PASSAGEM AS P
JOIN tb_tipoadmissao AS T ON T.id_tipoadmissao = P.TIPO_ADMISSAO
GROUP BY  YEAR(P.DATA_ADMISSAO), MONTH(P.DATA_ADMISSAO), DAY(P.DATA_ADMISSAO), T.desc_tipoadmissao

SELECT YEAR(DATA_ADMISSAO)AS ANO, AVG (DATEDIFF(MINUTE,DATA_ADMISSAO, DT_ALTA)) AS MEDIA_MINUTOS
FROM TB_PASSAGEM
WHERE YEAR(DATA_ADMISSAO) BETWEEN 2015 AND 2017
GROUP BY YEAR(DATA_ADMISSAO)


SELECT YEAR(DATA_ADMISSAO)AS ANO, AVG (DATEDIFF(MINUTE,DATA_ADMISSAO, DT_ALTA)) AS MEDIA_MINUTOS
FROM TB_PASSAGEM
WHERE YEAR(DATA_ADMISSAO) BETWEEN 2015 AND 2017
GROUP BY YEAR(DATA_ADMISSAO)

SELECT
'MÉDIA ENTRE ANOS' AS DESCRIÇÃO,
(SELECT AVG (DATEDIFF(MINUTE,DATA_ADMISSAO, DT_ALTA)) FROM TB_PASSAGEM
 WHERE YEAR(DATA_ADMISSAO) = 2016) AS MEDIA_2016,
 (SELECT AVG (DATEDIFF(MINUTE,DATA_ADMISSAO, DT_ALTA)) FROM TB_PASSAGEM
 WHERE YEAR(DATA_ADMISSAO) = 2017) AS MEDIA_2017,
 (SELECT AVG (DATEDIFF(MINUTE,DATA_ADMISSAO, DT_ALTA)) FROM TB_PASSAGEM
 WHERE YEAR(DATA_ADMISSAO) = 2018) AS MEDIA_2018
